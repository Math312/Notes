# 实现远程过程调用(Implementing Remote Procedure Calls)

ANDREW D. BIRRELL and BRUCE JAY NELSON

## 摘要

远程过程调用（RPC）是高级语言编写的应用程序之间通过网络通讯的很有用的手段。本篇论文主要介绍了设计支持RPC功能的工具包时，设计人员会面临的问题，以及笔者做出的一些决策。

我们描述了RPC机制实现的整体结构、RPC客户端的绑定机制、用于网络通讯的传输层协议的设计，以及最后介绍了一下实现结果的性能。

除此之外，笔者还提供了一些用于提高本RPC工具包的性能和降低多客户端时服务器负载的优化方案。

## 1. 介绍

### 1.1 背景

远程过程调用（RPC）的思想非常简单。

首先过程调用是什么？过程通常情况下就是一些易于理解、众所周知的操作，这个操作可能是简单操作，例如i++，或者一些复杂的操作，例如解一个方程。然而调用一个过程，通常只需要两方面数据：

1. 负责控制层的操作数据，即如何操作需要处理的数据，例如要执行对i的自增操作，那么自增两个字就是负责控制层的操作数据
2. 要被处理的数据，同样是对i进行自增操作，那么i就是要被处理的数据。

理解了这一点之后，对于RPC机制的理解就简单了，由于RPC是远程过程调用，所以一定存在两端：

1. 调用端
2. 执行端（调用者）

调用端需要一套转化机制，将具体的动作和要被操作的数据全部转化为数据，然后交给执行端执行。而执行端需要对接收到的数据进行转化，转化为对应的操作，将数据进行的转化，这里类似于序列化和反序列化。

一次RPC通常要经历如下过程：

1. 调用端将参数传输到执行端，调用端挂起
2. 执行端接收到数据开始执行
3. 执行端处理完毕后，将结果返回给调用端
4. 调用端接收到结果，继续执行。

事实上，如果调用端合理利用了并发编程，或者RPC实现了异步调用时，调用端触发了RPC调用也无须阻塞，其他线程可以继续执行自身的操作。

RPC有很多吸引人的地方：

1. 清爽和简洁的语法：这使得构建分布式计算服务时更加简单，并且可以正确的获取服务与服务数据。
2. 高效：过程调用通常是很简单的，因此系统间通讯会很快。
3. 泛用性：在单机计算中，过程通常是算法各部分之间通信的最重要机制。

RPC这个话题已经被讨论很多年了，最早可以追溯到1976年。尼尔森（Nelson）的博士学位论文参考了以前有关RPC的许多工作，对RPC系统的设计可能性进行了广泛的研究。然而，对于RPC的真正实现却很少。最近值得注意的工作包括Xerox NS协议家族中的Courier，以及麻省理工学院的最新工作。

本文是Cedar项目中RPC实现结果的产物。由于有前人的一些借鉴（尤其是Nelson的理论与实验），我们了解到对于RPC设计者的我们需要针对我们自身的目的和所处的环境做出一系列选择。在真正构建系统的过程中，我们发现对几个领域我们的理解并不充分，因此，我们使用了自己一些设计创造了我们的系统。

作为RPC基础设施的设计者，我们面对的主要问题是：

1. 允许机器之间通讯失败的一套精确的语法
2. 允许没有共享地址空间支持的一套包含调用地址的语法
3. 如何将RPC系统集成到当前已有（或者未来会有）的系统中
4. 客户端绑定（调用者如何去确定被调用者的地址）
5. 如何设计一套合适的协议去转化调用者和被调用者之间的通讯使用的控制层数据与待处理数据
6. 在一个开放的网络中，如何保证数据完整性和数据安全性

在构建我们自己的RPC基础架构时，我们解决了这里的所有问题，但是不可能在一篇论文中以适当的深度描述所有这些问题。因此这篇论文仅仅包括了我的在解决上面问题中的一些主要决定，并且描述了解决方案的整体结构。在本篇文章中，我们也会介绍一些关于绑定机制和传输层协议的细节。我们计划去写一些子集的论文去详细介绍本篇文章没有介绍到的问题：

1. 基于加解密的报文安全问题
2. 介绍stub模块（该模块负责解释RPC调用的参数和结果）
3. 在使用自研RPC时的一些经验

## 1.2 环境

我们自研的RPC框架主要用在Cedar编程环境中，通过Xerox内网进行网络交互。在构建这类基础的框架时，环境因素不可避免会影响设计，因此这里首先对环境进行简单介绍。

Cedar是一个致力于可以便利的构建一个用于实验的程序或者系统的强大的开发平台。它强调统一，高度交互的用户界面，并简化程序的构造和调试。尽管Cedar还用于构建服务器（提供公共服务的共享计算机，可通过通信网络访问），但Cedar旨在用于单用户工作站。
