# 2-2 类型处理器源码分析

与类型别名注册表类似，类型处理器注册表也是由`BaseBuilder`管理的。同样一些其余的`XXXBuilder`需要使用类型处理器注册表，因此，`BaseBuilder`负责维护该属性。

接下来首先介绍一下类型处理器的功能。

## 2-2.1 类型处理器的功能

MyBatis 在设置预处理语句（PreparedStatement）中的参数或从结果集中取出一个值时， 都会用类型处理器将获取到的值以合适的方式转换成 Java 类型。

上面的解释摘自Mybatis文档，如果你对JDBC有一定使用经验的话，应该对这句话有比较深的理解，这里笔者使用JDBC构架另一个Demo，使用的库仍然是[第一节]()创建的库，只不过本次不再使用Mybatis操作数据库，而是使用原生JDBC。

这次完成的功能仅仅是通过id对数据进行查询：

```java
public class JdbcExample {

    public static void main(String[] args) {
        try {
            // 驱动加载
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            System.exit(-1);
        }
        String url = "jdbc:mysql://127.0.0.1:3306/mybatis";
        String username = "root";
        String password = "123456";
        Connection connection = null;
        PreparedStatement preparedStatement = null;
        ResultSet resultSet = null;
        try {
            // 创建连接
            connection = DriverManager.getConnection(url, username, password);
            // 准备PrepareStatement
            preparedStatement = connection.prepareStatement("select id,title,content from blog where id = ?");
            // 为PrepareStatement拼接参数
            preparedStatement.setInt(1, 4);
            // 执行SQL
            resultSet = preparedStatement.executeQuery();
            while (resultSet.next()) {
                // 读取结果
                System.out.println(resultSet.getString(1));
                System.out.println(resultSet.getString(2));
                System.out.println(resultSet.getString(3));
            }
        } catch (SQLException throwables) {
            throwables.printStackTrace();
        } finally {
            // 清理资源
            ...
        }
    }
}
```

为了减少代码行数，笔者省略了一些清除资源用的代码。通常情况下，使用JDBC进行数据库操作，我们需要执行如下几步：

1. 驱动加载
2. 创建连接
3. 准备PrepareStatement
4. 设置查询参数
5. 读取数据
6. 清理资源

这里我们主要关注第3-5步。如果使用PrepareStatement操作数据库时，为了防止出现SQL注入，我们通常都会将语句写成这种形式：

```sql
select id,title,content from blog where id = ?
```

其中参数通过`PrepareStatement`的各个set方法设置到对应的位置，例如本例中的：

```java
preparedStatement.setInt(1, 4);
```
这意味着将preparedStatement中第一个位置的参数按照Int型的方式设置为4。

等到查询出数据后，JDBC会通过ResultSet接到数据，然后可以通过其提供的get方法获取数据，例如：

```java
System.out.println(resultSet.getString(1));
```

上面代码的意思是，使用获取String的方式读取resultSet中第一列的数据。

在这之后我们考察一下`TypeHandler`这个接口，即Mybatis的类型处理器：

```java
public interface TypeHandler<T> {

  void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException;

  T getResult(ResultSet rs, String columnName) throws SQLException;

  T getResult(ResultSet rs, int columnIndex) throws SQLException;

  T getResult(CallableStatement cs, int columnIndex) throws SQLException;

}
```

可以看到，这里提供了两类方法：

1. 通过列索引（i）为PreparedStatement设置参数
2. 通过列索引（columnIndex）读取ResultSet中的结果集

其实`TypeHandler`就是对PreparedStatement的简单封装，可以让JDBC_TYPE映射到JavaType更加规范化，而不用自己手写了罢了。

