# 7.Java注解方式配置的mapper标签的解析

解析`<mappers>`标签时，我们说过，Mybatis中`Mapper`接口的配置方式有两种，一种是xml文件配置，就是上一节解释的那种。另一种是基于Java注解方式的配置，这种配置的解析由`MapperRegistry.addMapper(Class<T> type)`处理。

同样给出一个Java注解方式配置mapper的例子：

```java
@Insert("insert into table3 (id, name) values(#{nameId}, #{name})")
@SelectKey(statement="call next value for TestSequence", keyProperty="nameId", before=true, resultType=int.class)
int insertTable3(Name name);
```

关于更多Java注解方式配置`Mapper`接口的细节请查看如下文档：

[https://mybatis.org/mybatis-3/zh/java-api.html](https://mybatis.org/mybatis-3/zh/java-api.html)

本节主要讨论基于Java注解配置的解析过程，即`MapperRegistry.addMapper(Class<T> type)`方法。

```java
public <T> void addMapper(Class<T> type) {
    // 如果Mapper类不是接口，则不解析
    if (type.isInterface()) {
      // 如果已经解析过也不解析
      if (hasMapper(type)) {
        throw new BindingException("Type " + type + " is already known to the MapperRegistry.");
      }
      boolean loadCompleted = false;
      try {
        // 将Mapper标记为已被解析
        knownMappers.put(type, new MapperProxyFactory<T>(type));
        // 创建MapperAnnotationBuilder开始解析Class对象
        MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type);
        // 解析
        parser.parse();
        loadCompleted = true;
      } finally {
        // 解析失败，则从已解析注册表中删除该Class对象
        if (!loadCompleted) {
          knownMappers.remove(type);
        }
      }
    }
  }
```

上面的代码有3点需要注意：

1. Mapper必须是接口，不能是类：这是因为Mybatis使用的是Java动态代理，是基于接口的，而不是基于子类的，因此如果不是接口，则无法正常使用。
2. 先将Mapper标记为已解析，再进行真正的解析操作：阅读了上一节文章应该清楚，XML文件解析过后会查找对应的Java类型进行再次解析
