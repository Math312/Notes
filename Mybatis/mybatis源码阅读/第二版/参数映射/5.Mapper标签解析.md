# Mappers标签解析

对于Mybatis来说，Mapper对象提供了主要的持久化功能，因此，这部分实际上是整个框架的主要功能。正是Mapper对象，将XML文件中的配置与Java对象映射起来。本部分，我们开始分析`<mappers>`标签的解析。

在Mybatis配置文件中，Mapper相关的配置标签有两个，分别是`<mappers>`和`<mapper>`，前者用于配置`<mapper>`标签配置文件所在的位置，后者则是真正的Mapper对象映射的内容。下面给出Mybatis文档中允许的几种`<mappers>`标签配置方式：

```xml
<!-- 使用相对于类路径的资源引用 -->
<mappers>
  <mapper resource="org/mybatis/builder/AuthorMapper.xml"/>
  <mapper resource="org/mybatis/builder/BlogMapper.xml"/>
  <mapper resource="org/mybatis/builder/PostMapper.xml"/>
</mappers>
<!-- 使用完全限定资源定位符（URL） -->
<mappers>
  <mapper url="file:///var/mappers/AuthorMapper.xml"/>
  <mapper url="file:///var/mappers/BlogMapper.xml"/>
  <mapper url="file:///var/mappers/PostMapper.xml"/>
</mappers>
<!-- 使用映射器接口实现类的完全限定类名 -->
<mappers>
  <mapper class="org.mybatis.builder.AuthorMapper"/>
  <mapper class="org.mybatis.builder.BlogMapper"/>
  <mapper class="org.mybatis.builder.PostMapper"/>
</mappers>
<!-- 将包内的映射器接口实现全部注册为映射器 -->
<mappers>
  <package name="org.mybatis.builder"/>
</mappers>
```

可以看到，对于`<mappers>`标签有四种配置方式，其中`resource`属性和`url`属性都是基于`xml`文件配置`mapper`标签，而后两种是通过`Java注解方式`配置`mapper`标签。

下面我们开始分析Mybatis如何对这两类配置进行解析。

## 解析标签

在`XMLConfigBuilder`类中，解析`<mappers>`标签的工作是由`mapperElement(XNode)`方法完成的。我们可以考察该方法：

```java
private void mapperElement(XNode parent) throws Exception {
    if (parent != null) {
      for (XNode child : parent.getChildren()) {
        if ("package".equals(child.getName())) {
          // 解析Java包中的所有Class文件
          ...
        } else {
          String resource = child.getStringAttribute("resource");
          String url = child.getStringAttribute("url");
          String mapperClass = child.getStringAttribute("class");
          if (resource != null && url == null && mapperClass == null) {
            // 读取本地XML文件，进行解析
            ...
          } else if (resource == null && url != null && mapperClass == null) {
            // 读取url指向的xml文件，进行解析
            ...
          } else if (resource == null && url == null && mapperClass != null) {
            // 解析<mapper>标签中显式指定的Class文件
            ...
          } else {
            throw new BuilderException("A mapper element may only specify a url, resource or class, but not more than one.");
          }
        }
      }
    }
  }
```

可以看到，由于`mappers`标签有四种配置方式，这里明显分出了4中解析方式，但是其实这四种解析方式是两两一组的，首先我们可以看一下根据xml文件进行解析的两种情况，他们都是如下模式：

```java
ErrorContext.instance().resource(url);
// InputStream inputStream = Resources.getResourceAsStream(resource);
InputStream inputStream = Resources.getUrlAsStream(url);
XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());
mapperParser.parse();
```

可以看到，解析XML文件的模式都是获取xml文件，将其读取成流，然后交给`XMLMapperBuilder`进行处理。在之前分析`XMLConfigBuilder`时，我们就说过`BaseBuilder`的所有子类中，除了`XMLConfigBuilder`，都是为了解析`<mapper>标签`服务的，这正是使用了`XMLMapperBuilder`。

而对于Java注解型的配置，解析单个`mapper标签`的配置是用如下代码完成的：

```java
Class<?> mapperInterface = Resources.classForName(mapperClass);
configuration.addMapper(mapperInterface);
```

真正的`mapper标签`解析逻辑在`Configuration的addMapper(Class<T> type)`方法中，实际上，该方法又调用了`mapperRegistry`的`addMapper(Class<T> type)`方法：

```java
public <T> void addMapper(Class<T> type) {
  mapperRegistry.addMapper(type);
}
```

至于`mapperRegistry的addMapper(Class<T>)`方法的具体逻辑将在下面解析`<mapper>标签`时进行讨论。

最后，我们需要讨论一下`mapper标签`提供`包名称`的配置解析，其解析代码如下：

```java
String mapperPackage = child.getStringAttribute("name");
configuration.addMappers(mapperPackage);
```

实际上，`Configuration的addMapper(Class<T> type)`方法又是调用了`mapperRegistry`的`addMappers(String packageName)`方法，该方法用于解析包中，父类是`Object`类型的类，对其调用`addMapper(Class)`方法。

```java
public void addMappers(String packageName, Class<?> superType) {
    ResolverUtil<Class<?>> resolverUtil = new ResolverUtil<>();
    resolverUtil.find(new ResolverUtil.IsA(superType), packageName);
    Set<Class<? extends Class<?>>> mapperSet = resolverUtil.getClasses();
    for (Class<?> mapperClass : mapperSet) {
      addMapper(mapperClass);
    }
}
```

综上所属，实际上，对于XML文件格式的`mapper`标签的解析，由`XMLMapperBuilder`进行处理，而对于Java格式的`mapper`标签解析是通过`MapperRegistry`的`addMapper(Class<T> type)`方法完成的。

至此，`mappers标签`的解析逻辑就分析完了，可以看到，其实`mappers`标签的解析中，最重要的还是`mapper`标签的解析，而这一部分我们将会在后面进行详细讲解`mapper`配置文件的解析也是mybatis中最复杂的部分，甚至比执行逻辑还复杂，迫不及待了吧。让我们进入下一节，解析`mapper`标签的配置吧。
