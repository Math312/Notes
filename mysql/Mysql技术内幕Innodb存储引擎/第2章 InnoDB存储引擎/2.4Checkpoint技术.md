# 2.4 Checkpoint技术

由于缓冲池的目的是为了协调CPU速度与磁盘速度的鸿沟。因此页的操作首先都是在缓冲池中完成地。如果一条DML语句，如Update或Delete改变了页中的记录，那么此时页是脏的，数据库需要将新版本地页从缓冲池刷新到磁盘。

然而刷新操作面临如下的问题：

1. 每次内存数据变化就同步刷新，每个页变化一次就刷新一次，会造成巨大开销。
2. 为了保证事务的持久性，当前事务数据库系统普遍采用了Write Ahead Log策略，即事务提交时，先写重做日志，再修改页。但重做日志不可能无限增大（硬件无法支持，重做日志越大，Mysql启动越慢），缓冲池中缓存的数据也不可能无限的增多（在物理硬件上内存无法达到无限）。

因此引入了CheckPoint解决以下问题：

1. 缩短数据库的恢复时间。
2. 缓冲池不够用时，讲脏页刷新到磁盘。
3. 重做日志不可用时，刷新脏页。

当数据库发生宕机时，数据库不需要重做所有的日志，因为CheckPoint之前的页都已经刷新回磁盘中。数据库只需要对CheckPoint后的重做日志进行恢复，大大缩短了恢复的时间。

此外，当缓冲池不够用时，根据LRU算法会溢出最近最少使用的页，若此页为脏页，那么需要强制执行Checkpoint，将脏页也就是页的新版本刷回磁盘。

重做日志出现不可用的情况是因为当前事务数据库系统对重做日志的设计都是循环使用的，并不是让其无限增大的。重做日志可以被重用的部分是指浙西重做日志已经不再需要，即当数据库发生宕机时，数据库恢复操作不需要这部分的重做日志，因此这部分就可以被覆盖重用。若此时重做日志还需要使用，那么必须强制产生Checkpoint，将缓冲池中的页至少刷新到当前重做日志的位置。

对于InnoDB存储引擎而言，其是通过LSN(Log Sequence Number)来标记版本的。而LSN是8字节的数字。其单位是字节。每个页有LSN，重做日志中也有LSN，CheckPoint也有LSN。可以通过SHOW ENGINE INNODB STATUS来观察：

```
LOG
---
Log sequence number 85459539
Log flushed up to   85459539
Pages flushed up to 85459539
Last checkpoint at  85459493
0 pending log flushes, 0 pending chkp writes
29167 log i/o's done, 0.31 log i/o's/second
```

在Innodb存储引擎中，Checkpoint发生的时间、条件及脏页的选择等都非常复杂。而Checkpoint所做的事情无外乎是将缓冲池中的脏页刷回到磁盘。不同之处在于每次刷新多少页到硬盘，每次从哪里取脏页，以及什么时间触发Checkpoint。在InnoDB存储引擎内部，有两种Checkpoint，分别是:

- Sharp Checkpoint
- Fuzzy Checkpoint

Sharp Checkpoint发生在数据库关闭时将所有的脏页都刷新回磁盘，这是默认的工作方式，即参数innodb_fast_shutdown=1。

但是如果数据库在运行时也使用Sharp Checkpoint，那么数据库的可用性就会受到很大的影响。故在InnoDB存储引擎内部使用Fuzzy Checkpoint进行页的刷新，即只刷新一部分脏页，而不是刷新所有的脏页回磁盘。

在InnoDB存储引擎中可能发生如下几种情况的Fuzzy Checkpoint：

- Master Thread Checkpoint
- FLUSH_LRU_LIST Checkpoint
- Async/Sync Flush Checkpoint
- Dirty Page too much Checkpoint

